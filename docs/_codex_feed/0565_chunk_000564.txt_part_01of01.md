# File: chunk_000564.txt (part 1 of 1)
```
calculate the KVCs of the PIN encryption key and the MAC key. F.5.9 PIN key 1. The host sends the encrypted PIN encryption key to the ATM in an Extended Encryption Key Load message (Message Class 3, Message Sub-class 4) with Modifier ‘2’ - ‘Decipher new communications key with current master key’. 2. The ATM’s EPP decrypts the communications key and stores it for encrypting PIN blocks see (F.5.11). 3. The ATM sends the KVC of the communications key to the host in an Encryptor Initialisation Data message (Message Class 2, Message Sub- class 3) with Information Identifier ‘3’ - ‘New KVV for key just loaded’. 4. The host compares the KVC of the communications key with the KVC returned by SCM function 7510. If they do not match, the host displays a console message65. F.5.10 MAC key 1. The host sends the encrypted MAC key to the ATM in an Extended Encryption Key Load message (Message Class 3, Message Sub-class 4) with Modifier ‘5’ - ‘Decipher new MAC key with current master key’. 2. The ATM’s EPP decrypts the MAC key and stores it for generating and verifying MACs (see - and F.5.13). 3. The ATM sends the KVC of the MAC key to the host in an Encryptor Initialisation Data message (Message Class 2, Message Sub-class 3) with Information Identifier ‘3’ - ‘New KVV for key just loaded’. 4. The host compares the KVC of the MAC key with the KVC returned by SCM function 7510. If they do not match, the host displays a console message66. 65 The communications key has been loaded incorrectly on the ATM. PIN decryption will be unsuccessful. 66 The MAC key has been loaded incorrectly on the ATM. MAC verification will be unsuccessful. IAC CODE SET VOLUME 4 - DEVICE REQUIREMENTS AND CRYPTOGRAPHIC MANAGEMENT ANNEXURE F. INTRODUCTION TO DEVICE SUPPORT AND SCM FUNCTIONALITY Australian Payments Network Limited [ABN 12 055 136 519] 37 F.5.11 PIN translation with double-length session key APCA2000 PINBLOCKTRANS 6.3 to 6.3 6600 21 eKPE(PIN block) Transaction Request message eKPEs(PIN block) eKMV42(KPEr) NCR NDC+ ATM 21 eKMV28(KPEs) Host Comms Key Figure 7 PIN translation with double-length session key 1. The ATM is configured to encrypt the PIN block with the ATM Comms key. Prior to encryption, the ATM’s EPP formats the PIN in an AS 2805.3.1 format 0 PIN block (same as ISO format 0).67 2. The ATM sends the encrypted PIN block in a Transaction Request message (Message Class 1, Message Sub-class 1). 3. The host uses SCM function 6600 to translate the PIN block from encryption under the PIN encryption receive key to encryption under the PIN encryption send key. The PIN encryption receive key is the same as the ATM’s Communications key (see F.5.7). The PIN encryption send key is the host’s Switch Working Key68. 4. For an ‘on us’ transaction, the host uses the translated PIN block to verify the PIN. For a ‘not on us’ transaction, the host performs a second PIN translation to encrypt it under the issuer’s PIN encryption key. F.5.12 MAC generation with double-length session key Host APCA2000 MACGEN-NDC+ 5530 21 message data Transaction Reply message eKMV24(KMACs) NCR NDC+ ATM MAC Key MAC(message data) Figure 8 MAC generation with double-length session key 1. The host uses SCM function 5530 to generate the MAC. The MAC send key is the same as the ATM’s MAC key (see F.5.7). The MAC algorithm used by SCM function 5530 will be standardised as MAC algorithm 3 in the amendment to AS 2805.4.1 which is under preparation by the IT-5-4 committee. The MAC is calculated over the entire message. 2. The host sends the MAC in a Transaction Reply message (Message Class 4). 67 Amended effective 29/4/16, version 003 r&p 001.16 68 Assuming the host uses a SWK to encrypt all PIN blocks during internal processing on the switch. IAC CODE SET VOLUME 4 - DEVICE REQUIREMENTS AND CRYPTOGRAPHIC MANAGEMENT ANNEXURE F. INTRODUCTION TO DEVICE SUPPORT AND SCM FUNCTIONALITY Australian Payments Network Limited [ABN 12 055 136 519] 38 3. The ATM is configured to verify the MAC in the message data with the ATM MAC key. F.5.13 MAC verification with double-length session key Host APCA2000 MACVERIFY-NDC+ 5630 21 message data Transaction Request message eKMV48(KMACr) NCR NDC+ ATM MAC Key MAC(message data) Figure 9 MAC verification with double-length session key 1. The ATM is configured to MAC the message data with the ATM MAC key. 2. The ATM sends the MAC in a Transaction Request message (Message Class 1, Message Sub-class 1). 3. The host uses SCM function 5630 to verify the MAC. The MAC receive key is the same as the ATM’s MAC key (see F.5.7). The MAC algorithm used by SCM function 5630 is MAC algorithm 2 from AS 2805.4.1 (functionally equivalent to MAC algorithm 3 in ISO 9797-1). The MAC is calculated over the entire message. F.6 EFTPOS Terminals - 3DES69 Key management is accomplished by the exchange of messages between Terminal and host system(s), and the execution of complementary cryptographic functions by the Terminal and host application software. The following diagrams and descriptions are indicative of the messages and functions needed to support remote initialisation and session key management. Only those message fields relevant to key management are shown. For remote initialisation, three RSA key pairs are used. The modulus of each key pair is nominally 1024 bits in size, but the actual sizes
```

