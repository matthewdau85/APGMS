# File: chunk_000567.txt (part 1 of 1)
```
produced for 1DES POS Terminals. This would allow support of a hybrid POS Terminal which performed remote initialisation with 512-bit RSA keys but performed 3DES session key management. It is may be AusPayNet’s intention, however, to discontinue support for a format 23 KIA when 3DES migration is complete. F.6.6 Logon by a Terminal to an Acquirer Acquirer host Terminal → 0800 ← 0810 eKMV82(KEK1) eKMV88(PPASN) APCA2000 HOSTPROOF – 6.4 E510 {OWF(KEK1,PPASN)} APCA2000 TERMPROOF – 6.4 E500 {eKEK1(PPASN)} PPASNVERIFY A8 (KEK1 or KEK2) {OWF(KEK1,PPASN)} GETPPASN A7 (KEK1 or KEK2) {eKEK1(PPASN)} Logon - proof of terminal endpoint Logon - proof of terminal endpoint Logon - proof of host endpoint PPASNAIIC KEK1AIIC 21 Figure 15 Logon by a Terminal to an Acquirer 1. The Terminal sends the acquirer a cryptographic function of KEK1 and PPASN which the acquirer verifies to prove that the Terminal is genuine. 2. The acquirer sends the Terminal a cryptographic function of KEK1 and PPASN which the Terminal verifies to prove that the acquirer is genuine. This is just the cryptographic part of Terminal logon - other functions are performed by Terminal and acquirer at the same time. Proof of endpoint is normally performed with KEK1, as indicated by a flag in the messages. If proof of endpoint is unsuccessful with KEK1, suggesting that transformation of KEK1 has become out of step between Terminal and acquirer, proof of endpoint is attempted with KEK2. A session key change, as described below, is performed immediately after a successful proof of endpoint. IAC CODE SET VOLUME 4 - DEVICE REQUIREMENTS AND CRYPTOGRAPHIC MANAGEMENT ANNEXURE F. INTRODUCTION TO DEVICE SUPPORT AND SCM FUNCTIONALITY Australian Payments Network Limited [ABN 12 055 136 519] 43 F.6.7 Session Key Change by an Acquirer Terminal Acquirer host KEK1=KEK2L⊕ (PPASNPPASN) KEK2=OWF(KEK2 PPASN PPASN) KEK1=OWF(KEK1, PPASN PPASN) ← 0810 KEK flag=2 eKMV82(KEK1) APCA2000 TERMKEYGEN2 3510 eKMV82(KEK2) eKMV88(PPASN) eKMV24(KMACs) eKMV22(KDs) eKMV48(KMACr) eKMV42(KPP) eKMV44(KDr) eKEK1V24(KMACs eKEK1V22(KDs) eKEK1V48(KMACr) eKEK1V42(KPP) eKEK1V44(KDr) eKEK1V1(KMACr) eKEK1V3(KDr) eKEK1V1(KMACs) eKEK1V2(KPP) eKEK1V3(KDs) ACQSESSION 21 KEK2AIIC PPASNAIIC KEK1AIIC KMACrAIIC KDrAIIC KMACsAIIC KPPAIIC KDsAIIC Key change response → 0800 KEK flag=2 Key change request 21 21 21 21 21 21 21 31 31 31 31 31 KEK1=KEK2L⊕ (PPASNPPASN) KEK2=OWF(KEK2 PPASN PPASN) KEK1=OWF(KEK1, PPASN PPASN) Figure 16 Session Key Change by an Acquirer 1. The acquirer responds to a key change request by generating a set of random double-length session keys, encrypting them under variants of KEK1, and sending them to the Terminal. The KEK1 is transformed by a one way function before it is used. 2. The Terminal transforms KEK1, and decrypts the session keys. Note that the format 31 session keys generated by functions 3500 and 3510 are CBC-enciphered and that the variants of KEK1 or KEK2 are the ones shown in section F.4 (with C0 in alternate bytes). Session key change is normally performed with KEK1, as indicated by a flag in the messages. If the key verification codes are incorrect, suggesting that transformation of KEK1 has become out of step between Terminal and acquirer, a session key change is attempted with KEK2. This causes both acquirer and Terminal to derive a new KEK1 from KEK2 and transform KEK2 with a one way function. A session key change with KEK2 is also requested after doing a KEK2 proof of endpoint during Terminal logon. Although the key change request originates from the Terminal, each acquirer host can effectively control the frequency of session key changes by setting a “key change required” flag in a previous message to the Terminal, such as a financial transaction response. F.6.8 Financial Transaction from a Terminal to an Acquirer Terminal Acquirer host ← 0210 → 0200 eKMV24MACs) eKMV42(KPP) APCA2000 PINBLOCKTRANS – 6.4 TO 6.3 6610 transaction amount eKPEs(PIN) eKMV28(KPEs) STAN eKPE(PIN) KPE=OWF(KPP, (STAN || amount) KMACsAIIC KPPAIIC GETPIN 32 transaction amount STAN eKPE(PIN) PIN from PIN pad Issuer Key Financial transaction request APCA2000 MACGEN – 6.3 and 6.4 5500 MAC MACVER 43 MAC Financial transaction response MAC MAC eKMV48(KMACr) APCA2000 MACVERIFY – 6.3 and 6.4 5600 MACGEN 41 KMACrAIIC 21 21 21 21 KPE=OWF(KPP, (STAN || amount) Figure 17 Financial Transaction from a Terminal to an Acquirer IAC CODE SET VOLUME 4 - DEVICE REQUIREMENTS AND CRYPTOGRAPHIC MANAGEMENT ANNEXURE F. INTRODUCTION TO DEVICE SUPPORT AND SCM FUNCTIONALITY Australian Payments Network Limited [ABN 12 055 136 519] 44 1. The Terminal encrypts the PIN (entered by the customer on the PIN pad) using a PIN encryption key KPE which is derived from the PIN protection key (KPP) combined with the STAN and amount of the transaction. A MAC is generated on the financial transaction request message using the MAC session key (KMACs). 2. The acquirer verifies the MAC using the MAC session key (KMACr). 3. If the acquirer is the card issuer for the transaction (or is standing in for the card issuer), the customer’s PIN is verified using the issuer’s PIN verification key. Otherwise the transaction is switched to the card issuer for PIN verification - this is the case illustrated above, where the PIN block is translated to encryption under the KPEs for the issuer. The KPE used to decrypt the incoming PIN block for verification or translation is derived from the KPP, STAN, and amount, as on the Terminal. 4. The acquirer generates a MAC on the financial transaction response message using the MAC session key (KMACs). 5. The Terminal verifies the MAC on the financial transaction response message using the MAC session key (KMACr).
```

