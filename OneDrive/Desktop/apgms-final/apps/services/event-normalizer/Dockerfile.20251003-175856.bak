# apps/services/event-normalizer/Dockerfile
FROM python:3.11-slim

WORKDIR /app

# Copy only what we need first for better caching
COPY apps/services/event-normalizer/app ./app
COPY libs/json ./libs/schemas/json

# Install runtime deps (no Poetry here; plain pip keeps it simple)
RUN pip install --no-cache-dir \
      fastapi \
      "uvicorn[standard]" \
      pydantic \
      nats-py \
      orjson \
      prometheus-client

# Copy the launcher that auto-discovers or uses APP_MODULE
COPY apps/services/event-normalizer/run_normalizer.py /app/run_normalizer.py

ENV UVICORN_HOST=0.0.0.0 \
    UVICORN_PORT=8001 \
    UVICORN_WORKERS=1 \
    # Set this if your app is not app.main:app
    APP_MODULE=app.main:app

EXPOSE 8001
CMD ["python", "-u", "/app/run_normalizer.py"]
