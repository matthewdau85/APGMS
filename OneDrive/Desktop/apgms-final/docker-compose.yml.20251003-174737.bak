services:
  postgres:
    image: postgres:16
    environment:
      POSTGRES_USER: apgms
      POSTGRES_PASSWORD: apgms
      POSTGRES_DB: apgms
    ports: ["5432:5432"]
    healthcheck:
      test: ["CMD-SHELL","pg_isready -U apgms"]
      interval: 5s
      timeout: 5s
      retries: 20

  nats:
    image: nats:2.10-alpine
    command: ["-js", "-sd", "/data", "-m", "8222"]   # JetStream + storage dir + monitoring
    ports:
      - "4222:4222"
      - "8222:8222"
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://127.0.0.1:8222/healthz >/dev/null 2>&1 || exit 1"]
      interval: 5s
      timeout: 3s
      retries: 20

  normalizer:
    build:
      context: .
      dockerfile: apps/services/event-normalizer/Dockerfile
    environment:
      NATS_URL: nats://nats:4222
      SERVICE_PORT: "8001"
      PYTHONPATH: /app
    ports: ["8001:8001"]
    depends_on:
      nats:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://127.0.0.1:8001/healthz >/dev/null 2>&1 || exit 1"]
      interval: 5s
      timeout: 3s
      retries: 20
    restart: unless-stopped

  tax-engine:
    build: ./apps/services/tax-engine
    environment:
      NATS_URL: nats://nats:4222
      SERVICE_PORT: "8002"
    ports: ["8002:8002"]
    depends_on:
      nats:
        condition: service_healthy

  grafana:
    image: grafana/grafana:11.1.3
    ports: ["3000:3000"]
